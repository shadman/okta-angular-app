{"version":3,"file":"LanguageUtil.js","sources":["../../../../src/util/LanguageUtil.ts"],"sourcesContent":["import Bundles from 'util/Bundles';\nimport config from 'config/config.json';\nimport BrowserFeatures from './BrowserFeatures';\n\nimport { LanguageCallback, LanguageCode } from 'types';\nimport Util from './Util';\n\n/**\n * Utility that gets a list of language tag preferences based on the widget properties\n * and browser settings.\n * \n * NOTE: The language tag and language are related but not necessarilty the same.\n * The language tag specifies the language and region, and may be used for formatting dates\n * and currency, while the language is just the language code used for translations.\n * \n * @see https://en.wikipedia.org/wiki/IETF_language_tag\n * \n * @param {string | LanguageCallback | undefined} language \n * @param {string[]} supportedLanguages\n * @returns {string[]}\n */\nexport const getLanguageTags = (language: string | LanguageCallback | undefined, supportedLanguages: string[]): string[] => {\n  // Get the user's preferred languages from the browser API\n  const userLanguages = BrowserFeatures.getUserLanguages().map((userLanguage: string) => {\n    // Map \"simple\" language codes to their full locale equivalents to match the\n    // expected format for these specific languages.\n    if (userLanguage === 'nl') {\n      return 'nl-nl';\n    }\n    if (userLanguage === 'pt') {\n      return 'pt-br';\n    }\n    return userLanguage.toLowerCase();\n  });\n\n  const languagesMap = new Map<string, Set<string>>();\n\n  const addLanguageTag = (languageTag?: string): void => {\n    if (!languageTag) {\n      return;\n    }\n    // only get the simple language code, i.e. 'en', 'ja', 'zh'\n    const [lang] = languageTag.split('-');\n\n    if (languagesMap.has(lang)) {\n      const values = languagesMap.get(lang) ?? new Set<string>();\n      values.add(languageTag)\n      languagesMap.set(lang, values);\n    } else {\n      languagesMap.set(lang, new Set<string>([languageTag]));\n    }\n  };\n\n  const supportedUserLanguages = userLanguages.filter((userLanguage: string) => {\n    // remove any user languages tags that do not match a supported language\n    return supportedLanguages.some((supportedLang: string) => userLanguage.startsWith(supportedLang.toLowerCase()));\n  });\n\n  supportedUserLanguages.forEach(addLanguageTag);\n\n  Util.expandLanguages(supportedUserLanguages).forEach(addLanguageTag);\n\n  // Any developer defined \"language\" takes highest priority:\n  // As a string, i.e. 'en', 'ja', 'zh-CN'\n  let languageFromProps: string | undefined;\n  if (typeof language !== 'undefined') {\n    if (typeof language === 'string') {\n      languageFromProps = language.toLowerCase();\n    } else if (typeof language === 'function') {\n      // As a callback function, which is passed the list of supported\n      // languages and detected user languages. This function must return\n      // a languageCode, i.e. 'en', 'ja', 'zh-CN'\n      languageFromProps = language(supportedLanguages as LanguageCode[], userLanguages)?.toLowerCase();\n    }\n    // Add the language from widget properties to the languages map\n    Util.expandLanguages([languageFromProps]).forEach(addLanguageTag);\n  }\n\n  // Add default language, and expand to include any language\n  // codes that do not include region, dialect, etc.\n  Util.expandLanguages([config.defaultLanguage.toLowerCase()]).forEach(addLanguageTag);\n\n  const languageTags: string[] = [];\n\n  // Put languages related to the language from widget properties first if it was specified\n  if (languageFromProps) {\n    // Get the simple language code since that's how the languagesMap is keyed\n    const [lang] = languageFromProps.split('-');\n    // Pull the language tags for the specified language from the map first\n    languageTags.push(...(languagesMap.get(lang) ?? []))\n    // Then remove the language from the map so it doesn't get added again\n    languagesMap.delete(lang);\n  }\n\n  // Add any remaining language tags from the map to the returned array\n  languagesMap.forEach((values: Set<string>) => {\n    languageTags.push(...values);\n  });\n\n  return languageTags;\n};\n\n\nexport const loadLanguage = (appState, settings) => {\n  const languageCode = appState.get('languageCode') || settings.get('languageCode') || config.defaultLanguage;\n  const i18n = settings.get('i18n');\n  const assetBaseUrl = settings.get('assets.baseUrl');\n  const assetRewrite = settings.get('assets.rewrite');\n  const supportedLanguages = settings.get('supportedLanguages');\n\n  const timeout = setTimeout(function() {\n    // Trigger a spinner if we're waiting on a request for a new language.\n    appState.trigger('loading', true);\n  }, 200);\n\n  return Bundles.loadLanguage(languageCode, i18n, {\n    baseUrl: assetBaseUrl,\n    rewrite: assetRewrite,\n  }, supportedLanguages).then(function() {\n    clearTimeout(timeout);\n    appState.trigger('loading', false);\n    appState.trigger('removeLoading');\n  });\n  // TODO: what if load language error?\n}\n"],"names":["getLanguageTags","language","supportedLanguages","userLanguages","BrowserFeatures","getUserLanguages","map","userLanguage","toLowerCase","languagesMap","Map","addLanguageTag","languageTag","lang","split","has","values","get","Set","add","set","supportedUserLanguages","filter","some","supportedLang","startsWith","forEach","Util","expandLanguages","languageFromProps","config","defaultLanguage","languageTags","push","delete","loadLanguage","appState","settings","languageCode","i18n","assetBaseUrl","assetRewrite","timeout","setTimeout","trigger","Bundles","baseUrl","rewrite","then","clearTimeout"],"mappings":"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"}